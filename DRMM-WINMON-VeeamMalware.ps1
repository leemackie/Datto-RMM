<#
.SYNOPSIS
Using Datto RMM, check the Veeam Backup and Replication restore points for malware status.

Written by Lee Mackie - 5G Networks

.NOTES
Type: Monitor
Version 1.0 - Initial release
Version 1.1 - Updated to use Veeam.Backup.PowerShell module via code, standardised output and added verbosity.
Version 1.2 - Refactored to support Veeam B&R v13 and PowerShell 7, cleaned up some of the logic and calls
Version 1.2.1 - Fixed connection being called twice

#>

$script = @'

Import-Module "Veeam.Backup.PowerShell" -NoClobber -DisableNameChecking

function write-DRMMAlert ($message) {
    write-host '<-Start Result->'
    write-host "Alert=$message"
    write-host '<-End Result->'
}

function write-DRMMStatus ($message) {
    write-host '<-Start Result->'
    write-host "STATUS=$message"
    write-host '<-End Result->'
}
function Write-DRMMDiagnostic ($message) {
    write-host '<-Start Diagnostic->'
    write-host $message
    write-host '<-End Diagnostic->'
}

# Get DRMM variables and set variables
$alertLevel = $ENV:AlertLevel
$verbose = $ENV:Verbose
$drmmOutput = @()

try {
# If verbose enabled, start logging
if ($verbose -eq "True"){
    $timestamp = Get-Date -Format o | ForEach-Object { $_ -replace ":", "." }
    Start-Transcript -Path "C:\ProgramData\CentraStage\Temp\Veeam_Malware_$timestamp.txt" -Force
}

    Get-VBRCommand Connect-VBRServer |
    ForEach-Object {
        if ($_.Version -lt [version]"13.0") {
            Write-Host "- Veeam PowerShell module version $($_.Version) detected - using V12 and below connection method."
            Connect-VBRServer -Server localhost
        } else {
            Write-Host "- Veeam PowerShell module version $($_.Version) detected - using V13 and above connection method."
            Connect-VBRServer -Server localhost -ForceAcceptTlsCertificate
        }
    }

    # Get Veeam restore points
    $points = Get-VBRObjectRestorePoint | Select-Object Name,CreationDate,Status | Sort-Object CreationDate
    if ($verbose -eq "True") {
        Write-Host "$($points.Count) restore points found"
    }

    # Examine them for malware status
    foreach ($point in $points) {
        if ($verbose -eq "True") {
            Write-Host "Checked $($point.Name) - $($point.CreationDate) - $($point.Status)"
        }

        switch($point.Status) {
            "Suspicious" {
                $suspicious = $true
                $drmmOutput += "? $($point.CreationDate) - $($point.Name) - SUSPICIOUS`n"
            }
            "Infected" {
                $infected = $true
                $drmmOutput += "! $($point.CreationDate) - $($point.Name) - INFECTED`n"
            }
        }
    }

    if ($infected -eq $true -and $alertLevel -ne "Suspicious") {
        write-DRMMAlert "BAD: VEEAM REPORTING INFECTED RESTORE POINTS"
        Write-DRMMDiagnostic $drmmOutput
        Exit 1
    } elseif ($suspicious -eq $true -and $alertlevel -ne "Infected"){
        Write-DRMMAlert "BAD: Veeam reporting suspicious restore points"
        Write-DRMMDiagnostic $drmmOutput
        Exit 1
    } else {
        Write-DRMMStatus "OK: No malware found"
    }
} catch {
    Write-DRMMAlert "BAD: Script failed - enable verbose mode and check output"
    Write-DRMMDiagnostic "Script failed - please investigate VBR and PowerShell on server.`n $($_.ScriptStackTrace)`n$($_.Exception)"
    Write-Host $_
    Exit 1
}

'@

# A rather annoying method to determine which version of PowerShell and Veeam module is installed, until Datto RMM supports PowerShell 7 natively
Get-Module -ListAvailable -Name "Veeam.Backup.PowerShell" | ForEach-Object {
    if ($_.Version -lt [version]"13.0" -and $_.Version -ne [version]"0.0") {
        Write-Host "- Veeam PowerShell module version $($_.Version) detected - using standard PowerShell."
        $script | Invoke-Expression
    } elseif ($_.Version -ge [version]"13.0" -or $_.Version -eq [version]"0.0") {
        if (-not $(Get-Command pwsh -ErrorAction SilentlyContinue)) {
            Write-Host "!! ERROR: PowerShell 7 is not installed on this system. This script requires PowerShell 7 to run."
            Exit 1
        }
        Write-Host "- Veeam B&R v13 detected - using PowerShell 7."
        $script | pwsh -Command -
    } else {
        Write-Host "!! ERROR: Veeam PowerShell module not found - please ensure Veeam Backup & Replication is installed on this system."
        Exit 1
    }
}